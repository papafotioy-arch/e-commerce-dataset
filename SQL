SQL QUERIES


01_combine_tables.sql

CREATE OR REPLACE TABLE staging.orders_raw AS
SELECT *, 'sheet1' AS source_sheet 
FROM relay_dataset.relay_dataset1
UNION ALL
SELECT *, 'sheet2' AS source_sheet 
FROM relay_dataset.relay_dataset2
UNION ALL
SELECT *, 'sheet3' AS source_sheet 
FROM relay_dataset.relay_dataset3;


02_standardize_columns.sql

CREATE OR REPLACE TABLE staging.orders_standardized AS
SELECT
  order_id,
  customer_name,
  email,
  order_date,
  product,
  category,
  price,
  quantity,
  country,
  sales_channel,
  payment_type,
  order_status,
  discount_applied,
  customer_age,
  newsletter_signup,
  source_sheet
FROM staging.orders_raw;


03_clean_types.sql

CREATE OR REPLACE TABLE staging.orders_typed AS
SELECT
  -- IDs and text fields
  CAST(order_id AS STRING) AS order_id,
  TRIM(REGEXP_REPLACE(customer_name, r'\s+', ' ')) AS customer_name,
  TRIM(REGEXP_REPLACE(email, r'\s+', ' ')) AS email,

  -- Multi-format date parser
  SAFE.PARSE_DATE(
    '%Y-%m-%d',
    CASE
      WHEN REGEXP_CONTAINS(order_date, r'^\d{4}\.\d{2}\.\d{2}$')
        THEN REPLACE(order_date, '.', '-')
      WHEN REGEXP_CONTAINS(order_date, r'^\d{2}/\d{2}/\d{4}$')
        THEN FORMAT_DATE('%Y-%m-%d', PARSE_DATE('%d/%m/%Y', order_date))
      WHEN REGEXP_CONTAINS(order_date, r'^\d{2}-[A-Za-z]{3}-\d{2}$')
        THEN FORMAT_DATE('%Y-%m-%d', PARSE_DATE('%d-%b-%y', order_date))
      ELSE NULL
    END
  ) AS order_date,

  -- Product & category
  TRIM(REGEXP_REPLACE(product, r'\s+', ' ')) AS product,
  TRIM(REGEXP_REPLACE(category, r'\s+', ' ')) AS category,

  -- Price cleanup
  SAFE_CAST(REGEXP_REPLACE(price, r'[^0-9\.]', '') AS FLOAT64) AS price,

  -- Numeric fields
  SAFE_CAST(quantity AS INT64) AS quantity,
  SAFE_CAST(customer_age AS INT64) AS customer_age,

  -- Text fields
  TRIM(REGEXP_REPLACE(country, r'\s+', ' ')) AS country,
  TRIM(REGEXP_REPLACE(sales_channel, r'\s+', ' ')) AS sales_channel,
  TRIM(REGEXP_REPLACE(payment_type, r'\s+', ' ')) AS payment_type,
  TRIM(REGEXP_REPLACE(order_status, r'\s+', ' ')) AS order_status,

  -- Boolean-like fields
  CASE
    WHEN LOWER(CAST(discount_applied AS STRING)) IN ('yes','true','1') THEN TRUE
    WHEN LOWER(CAST(discount_applied AS STRING)) IN ('no','false','0') THEN FALSE
    ELSE NULL
  END AS discount_applied,

  CASE
    WHEN LOWER(CAST(newsletter_signup AS STRING)) IN ('yes','true','1') THEN TRUE
    WHEN LOWER(CAST(newsletter_signup AS STRING)) IN ('no','false','0') THEN FALSE
    ELSE NULL
  END AS newsletter_signup,

  -- Metadata
  source_sheet

FROM staging.orders_standardized;


04_clean_emails.sql

CREATE OR REPLACE TABLE staging.orders_email_clean AS
SELECT
  *, REGEXP_REPLACE(
    REGEXP_REPLACE(email, r'\s+', ''),
    r'@@', '@') AS email_fixed,
  REGEXP_CONTAINS(
    REGEXP_REPLACE(email, r'\s+', ''),
    r'^[^@]+@[^@]+\.[^@]+$') AS email_valid
FROM staging.orders_typed;


05_clean_country.sql

CREATE OR REPLACE TABLE staging.orders_country_clean AS
SELECT
  *,
  CASE
    WHEN UPPER(country) IN ('GB', 'U.K.', 'UNITED KINGDOM', 'UK') THEN 'UK'
    ELSE country
  END AS country_clean
FROM staging.orders_email_clean;


06_clean_status.sql

CREATE OR REPLACE TABLE staging.orders_status_clean AS
SELECT
  *,
  INITCAP(order_status) AS order_status_clean,
  INITCAP(sales_channel) AS sales_channel_clean
FROM staging.orders_country_clean;


07_product_category_fix.sql

CREATE OR REPLACE TABLE staging.orders_product_category_clean AS
SELECT
  *,

  CASE
    -- Correct fashion product categories
    WHEN LOWER(product) = 'cap' THEN 'Accessories'
    WHEN LOWER(product) = 'denim jacket' THEN 'Clothing'
    WHEN LOWER(product) = 'graphic tee' THEN 'Clothing'
    WHEN LOWER(product) = 'hoodie' THEN 'Clothing'
    WHEN LOWER(product) = 'running shoes' THEN 'Footwear'
    WHEN LOWER(product) = 'trainers' THEN 'Footwear'

    -- Handle bad/incomplete product rows
    WHEN LOWER(product) = 'h' THEN NULL

    -- Otherwise, keep original category
    ELSE category
  END AS category_clean,

  product AS product_clean

FROM staging.orders_status_clean;


08_remove_duplicates/NULLs/ABS.sql

CREATE OR REPLACE TABLE staging.orders_final AS
SELECT DISTINCT
  order_id,
  customer_name,
  email_fixed AS email,
  email_valid,
  customer_age,
  order_date,
  product_clean AS product,
  category_clean AS category,
  price,
  ABS(quantity) AS quantity,
  country_clean AS country,
  sales_channel_clean AS sales_channel,
  payment_type,
  order_status_clean AS order_status,
  discount_applied,
  newsletter_signup,
  source_sheet
FROM staging.orders_product_category_clean
WHERE quantity IS NOT NULL;


